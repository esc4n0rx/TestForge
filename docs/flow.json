{
  "apiVersion": "1.1.0",
  "title": "TestForge - Flow API",
  "description": "API completa para gerenciamento de Flows (fluxos de teste, processos e program flows)",
  "baseUrl": "/api/flows",
  "lastUpdated": "2026-01-18",

  "importantNotes": {
    "currentVersionId": "ATENCAO: O campo 'currentVersionId' pode ser NULL mesmo com versoes existentes. Sempre use o array 'versions' para obter as versoes do flow.",
    "versionAccess": "Para obter a versao atual, use: flow.versions[0] (versoes vem ordenadas por versionNumber DESC)",
    "cardsAccess": "Os cards estao dentro de currentVersion.cards (quando currentVersion nao e null) ou devem ser buscados separadamente"
  },

  "features": {
    "flow_versioning": "Versionamento e rollback de flows (Team/Enterprise)",
    "flow_execution_logs": "Logs de execucao de flows (Team/Enterprise)",
    "flow_export": "Exportacao de flows para PDF/CSV (Team/Enterprise)",
    "flow_templates": "Templates reutilizaveis (Start: 5, Team/Enterprise: ilimitado)",
    "flow_environments": "Ambientes separados DEV/QA/PROD (Enterprise only)"
  },

  "limits": {
    "forge_start": {
      "max_flows": 10,
      "flow_versioning": false,
      "flow_execution_logs": false,
      "flow_export": false,
      "flow_templates": 5,
      "flow_environments": false
    },
    "forge_team": {
      "max_flows": -1,
      "flow_versioning": true,
      "flow_execution_logs": true,
      "flow_export": true,
      "flow_templates": -1,
      "flow_environments": false
    },
    "forge_enterprise": {
      "max_flows": -1,
      "flow_versioning": true,
      "flow_execution_logs": true,
      "flow_export": true,
      "flow_templates": -1,
      "flow_environments": true
    }
  },

  "enums": {
    "FlowType": ["TEST", "PROGRAM_FLOW", "PROCESS"],
    "FlowStatus": ["DRAFT", "ACTIVE", "DELETED"],
    "FlowEnvironment": ["NONE", "DEV", "QA", "STAGING", "PRODUCTION"],
    "CardType": {
      "all": ["START", "END", "ACTION", "EVENT", "DECISION", "ASSERT", "EVIDENCE", "ERROR", "CONDITION", "LOOP", "STATE", "COMMENT", "TECH_NOTE"],
      "byFlowType": {
        "TEST": ["START", "END", "ACTION", "EVENT", "DECISION", "ASSERT", "EVIDENCE", "ERROR", "COMMENT", "TECH_NOTE"],
        "PROGRAM_FLOW": ["START", "END", "ACTION", "EVENT", "DECISION", "CONDITION", "LOOP", "STATE", "COMMENT", "TECH_NOTE"],
        "PROCESS": ["START", "END", "ACTION", "EVENT", "DECISION", "COMMENT", "TECH_NOTE"]
      },
      "exclusive": {
        "TEST_ONLY": ["ASSERT", "EVIDENCE", "ERROR"],
        "PROGRAM_FLOW_ONLY": ["CONDITION", "LOOP", "STATE"]
      }
    }
  },

  "responses": {
    "listFlows": {
      "endpoint": "GET /api/flows",
      "description": "Lista todos os flows do workspace",
      "queryParams": {
        "type": "TEST | PROGRAM_FLOW | PROCESS (opcional)",
        "environment": "NONE | DEV | QA | STAGING | PRODUCTION (opcional)",
        "isTemplate": "true | false (opcional)",
        "spaceId": "number (opcional)"
      },
      "example": {
        "success": true,
        "data": {
          "flows": [
            {
              "id": 38,
              "workspaceId": 7,
              "spaceId": null,
              "name": "Criar Pedido de Compra - ME21N",
              "description": "Fluxo detalhado para criacao de pedido de compra no SAP",
              "type": "PROCESS",
              "environment": "NONE",
              "isTemplate": false,
              "currentVersionId": null,
              "versionCount": 1,
              "createdBy": 10,
              "createdAt": "2026-01-18T18:26:56.756Z",
              "updatedAt": "2026-01-18T18:26:56.756Z",
              "workspace": {
                "id": 7,
                "name": "Minha Empresa",
                "slug": "minha-empresa"
              },
              "space": null,
              "creator": {
                "id": 10,
                "nome": "Paulo Santos",
                "email": "paulo@empresa.com"
              },
              "currentVersion": null,
              "versions": [
                {
                  "id": 38,
                  "flowId": 38,
                  "versionNumber": 1,
                  "status": "DRAFT",
                  "name": "Criar Pedido de Compra - ME21N",
                  "description": "Fluxo detalhado para criacao de pedido de compra no SAP",
                  "type": "PROCESS",
                  "changeLog": "Versao inicial",
                  "createdBy": 10,
                  "createdAt": "2026-01-18T18:26:56.756Z"
                }
              ]
            }
          ]
        }
      },
      "frontendUsage": {
        "getVersion": "const currentVersion = flow.versions[0]; // versions ordenado por versionNumber DESC",
        "getVersionId": "const versionId = flow.versions[0]?.id;",
        "checkActive": "const isActive = flow.versions[0]?.status === 'ACTIVE';",
        "checkDraft": "const isDraft = flow.versions[0]?.status === 'DRAFT';"
      }
    },

    "getFlow": {
      "endpoint": "GET /api/flows/:flowId",
      "description": "Busca um flow especifico por ID",
      "example": {
        "success": true,
        "data": {
          "flow": {
            "id": 38,
            "workspaceId": 7,
            "spaceId": null,
            "name": "Criar Pedido de Compra - ME21N",
            "description": "Fluxo detalhado para criacao de pedido de compra no SAP",
            "type": "PROCESS",
            "environment": "NONE",
            "isTemplate": false,
            "currentVersionId": null,
            "versionCount": 1,
            "createdBy": 10,
            "createdAt": "2026-01-18T18:26:56.756Z",
            "updatedAt": "2026-01-18T18:26:56.756Z",
            "workspace": {
              "id": 7,
              "name": "Minha Empresa",
              "slug": "minha-empresa"
            },
            "space": null,
            "creator": {
              "id": 10,
              "nome": "Paulo Santos",
              "email": "paulo@empresa.com"
            },
            "currentVersion": null,
            "versions": [
              {
                "id": 38,
                "flowId": 38,
                "versionNumber": 1,
                "status": "DRAFT",
                "name": "Criar Pedido de Compra - ME21N",
                "description": "Fluxo detalhado para criacao de pedido de compra no SAP",
                "type": "PROCESS",
                "changeLog": "Versao inicial",
                "createdBy": 10,
                "createdAt": "2026-01-18T18:26:56.756Z"
              }
            ]
          }
        }
      },
      "frontendUsage": {
        "getVersion": "const version = response.data.flow.versions[0];",
        "getCards": "const cards = response.data.flow.currentVersion?.cards || [];",
        "note": "Se currentVersion for null, os cards devem ser buscados via versions[0] apos ativacao"
      }
    },

    "createFlow": {
      "endpoint": "POST /api/flows",
      "description": "Cria um novo flow",
      "requestBody": {
        "name": "string (obrigatorio, 2-200 chars)",
        "description": "string (opcional, max 1000 chars)",
        "type": "TEST | PROGRAM_FLOW | PROCESS (obrigatorio)",
        "environment": "NONE | DEV | QA | STAGING | PRODUCTION (opcional, default: NONE)",
        "isTemplate": "boolean (opcional, default: false)",
        "spaceId": "number (opcional)"
      },
      "example": {
        "success": true,
        "data": {
          "flow": {
            "id": 39,
            "workspaceId": 7,
            "spaceId": null,
            "name": "Novo Flow de Teste",
            "description": "Descricao do flow",
            "type": "TEST",
            "environment": "NONE",
            "isTemplate": false,
            "currentVersionId": null,
            "versionCount": 1,
            "createdBy": 10,
            "createdAt": "2026-01-18T19:00:00.000Z",
            "updatedAt": "2026-01-18T19:00:00.000Z",
            "workspace": {
              "id": 7,
              "name": "Minha Empresa",
              "slug": "minha-empresa"
            },
            "space": null,
            "creator": {
              "id": 10,
              "nome": "Paulo Santos",
              "email": "paulo@empresa.com"
            },
            "versions": [
              {
                "id": 39,
                "flowId": 39,
                "versionNumber": 1,
                "status": "DRAFT",
                "name": "Novo Flow de Teste",
                "description": "Descricao do flow",
                "type": "TEST",
                "changeLog": "Versao inicial",
                "createdBy": 10,
                "createdAt": "2026-01-18T19:00:00.000Z"
              }
            ]
          }
        }
      },
      "frontendUsage": {
        "getFlowId": "const flowId = response.data.flow.id;",
        "getVersionId": "const versionId = response.data.flow.versions[0].id;",
        "note": "Use versionId para adicionar cards: POST /api/flows/versions/{versionId}/cards"
      },
      "errors": {
        "TEMPLATE_LIMIT_EXCEEDED": "Limite de templates atingido (5 para Start)",
        "ENVIRONMENTS_NOT_AVAILABLE": "Ambiente nao disponivel para este plano",
        "WORKSPACE_NOT_FOUND": "Workspace nao encontrado",
        "NOT_WORKSPACE_MEMBER": "Usuario nao e membro do workspace"
      }
    },

    "addCard": {
      "endpoint": "POST /api/flows/versions/:versionId/cards",
      "description": "Adiciona um card a uma versao do flow",
      "requestBody": {
        "type": "CardType (obrigatorio)",
        "title": "string (opcional, max 200 chars)",
        "content": "string (opcional, max 5000 chars)",
        "notes": "string (opcional, max 2000 chars)",
        "positionX": "number (opcional, default: 0)",
        "positionY": "number (opcional, default: 0)",
        "connections": "number[] (opcional, IDs de outros cards)"
      },
      "example": {
        "success": true,
        "data": {
          "card": {
            "id": 20,
            "versionId": 38,
            "type": "START",
            "title": "Inicio do Processo",
            "content": "Acessar SAP e executar transacao ME21N",
            "notes": null,
            "positionX": 100,
            "positionY": 50,
            "connections": "[]",
            "createdAt": "2026-01-18T18:27:04.429Z"
          }
        }
      },
      "frontendUsage": {
        "getCardId": "const cardId = response.data.card.id;",
        "parseConnections": "const connections = JSON.parse(response.data.card.connections);"
      },
      "errors": {
        "VERSION_NOT_FOUND": "Versao nao encontrada",
        "CANNOT_EDIT_ACTIVE_VERSION": "Nao e possivel editar versao ativa",
        "CARD_TYPE_NOT_ALLOWED_FOR_FLOW_TYPE": "Tipo de card nao permitido para este tipo de flow"
      }
    },

    "updateCard": {
      "endpoint": "PATCH /api/flows/cards/:cardId",
      "description": "Atualiza um card existente",
      "requestBody": {
        "title": "string (opcional)",
        "content": "string (opcional)",
        "notes": "string (opcional)",
        "positionX": "number (opcional)",
        "positionY": "number (opcional)",
        "connections": "number[] (opcional)"
      },
      "example": {
        "success": true,
        "data": {
          "card": {
            "id": 20,
            "versionId": 38,
            "type": "START",
            "title": "Inicio do Processo Atualizado",
            "content": "1. Acessar SAP GUI\n2. Digitar ME21N\n3. Pressionar Enter",
            "notes": "Nota adicional",
            "positionX": 100,
            "positionY": 50,
            "connections": "[]",
            "createdAt": "2026-01-18T18:27:04.429Z"
          }
        }
      }
    },

    "deleteCard": {
      "endpoint": "DELETE /api/flows/cards/:cardId",
      "description": "Remove um card e seus anexos",
      "example": {
        "success": true,
        "data": {
          "message": "Card removido com sucesso"
        }
      }
    },

    "activateVersion": {
      "endpoint": "POST /api/flows/:flowId/versions/:versionId/activate",
      "description": "Ativa uma versao do flow (torna-a publica/executavel)",
      "feature": "flow_versioning (Team/Enterprise)",
      "example": {
        "success": true,
        "data": {
          "flow": {
            "id": 38,
            "currentVersionId": 38,
            "versions": [
              {
                "id": 38,
                "status": "ACTIVE"
              }
            ]
          }
        }
      },
      "errors": {
        "VERSIONING_NOT_AVAILABLE": "Versionamento nao disponivel para este plano",
        "ACTIVE_FLOW_LIMIT_EXCEEDED": "Limite de flows ativos excedido"
      }
    },

    "deactivateFlow": {
      "endpoint": "POST /api/flows/:flowId/deactivate",
      "description": "Desativa o flow (volta para DRAFT)",
      "example": {
        "success": true,
        "data": {
          "flow": {
            "id": 38,
            "currentVersionId": null,
            "versions": [
              {
                "id": 38,
                "status": "DRAFT"
              }
            ]
          }
        }
      }
    },

    "createFromTemplate": {
      "endpoint": "POST /api/flows/templates/:templateId/create-flow",
      "description": "Cria um novo flow baseado em um template",
      "requestBody": {
        "name": "string (opcional - se nao informado, usa nome do template + ' (Copia)')"
      },
      "example": {
        "success": true,
        "data": {
          "flow": {
            "id": 40,
            "name": "Pedido de Compra - Filial SP",
            "isTemplate": false,
            "versions": [
              {
                "id": 40,
                "status": "DRAFT"
              }
            ]
          }
        }
      }
    },

    "errors": {
      "format": {
        "success": false,
        "error": {
          "message": "Descricao do erro",
          "code": "CODIGO_DO_ERRO"
        }
      },
      "codes": {
        "FLOW_NOT_FOUND": "Flow nao encontrado",
        "VERSION_NOT_FOUND": "Versao nao encontrada",
        "CARD_NOT_FOUND": "Card nao encontrado",
        "FORBIDDEN": "Sem permissao para esta acao",
        "VERSIONING_NOT_AVAILABLE": "Versionamento nao disponivel (requer Team/Enterprise)",
        "ENVIRONMENTS_NOT_AVAILABLE": "Ambientes nao disponiveis (requer Enterprise)",
        "TEMPLATE_LIMIT_EXCEEDED": "Limite de templates excedido",
        "ACTIVE_FLOW_LIMIT_EXCEEDED": "Limite de flows ativos excedido",
        "CANNOT_EDIT_ACTIVE_VERSION": "Nao pode editar versao ativa",
        "CARD_TYPE_NOT_ALLOWED_FOR_FLOW_TYPE": "Tipo de card nao permitido para este tipo de flow",
        "FLOW_NOT_ACTIVE": "Flow nao esta ativo",
        "CANNOT_EXECUTE_TEMPLATE": "Templates nao podem ser executados"
      }
    }
  },

  "frontendHelpers": {
    "getVersionFromFlow": {
      "description": "Como obter a versao atual de um flow",
      "code": "function getVersion(flow) {\n  // currentVersion pode ser null, use versions array\n  if (flow.currentVersion) {\n    return flow.currentVersion;\n  }\n  // versions vem ordenado por versionNumber DESC\n  return flow.versions?.[0] || null;\n}",
      "typescript": "function getVersion(flow: Flow): FlowVersion | null {\n  return flow.currentVersion || flow.versions?.[0] || null;\n}"
    },
    "getVersionId": {
      "description": "Como obter o ID da versao para adicionar cards",
      "code": "function getVersionId(flow) {\n  return flow.currentVersionId || flow.versions?.[0]?.id;\n}"
    },
    "getCards": {
      "description": "Como obter os cards de um flow",
      "code": "function getCards(flow) {\n  // Cards so existem em currentVersion quando flow esta ACTIVE\n  return flow.currentVersion?.cards || [];\n}"
    },
    "isFlowActive": {
      "description": "Verificar se flow esta ativo",
      "code": "function isFlowActive(flow) {\n  const version = flow.versions?.[0];\n  return version?.status === 'ACTIVE';\n}"
    },
    "canEditFlow": {
      "description": "Verificar se pode editar (apenas DRAFT)",
      "code": "function canEditFlow(flow) {\n  const version = flow.versions?.[0];\n  return version?.status === 'DRAFT';\n}"
    },
    "parseConnections": {
      "description": "Parsear campo connections de um card",
      "code": "function parseConnections(card) {\n  try {\n    return JSON.parse(card.connections || '[]');\n  } catch {\n    return [];\n  }\n}"
    }
  },

  "businessRules": {
    "permissions": {
      "OWNER": "Todas as acoes",
      "ADMIN": "Criar, editar, versionar, ativar/desativar, deletar",
      "MEMBER": "Criar e editar flows e cards"
    },
    "flowCreation": {
      "note": "Sistema permite criar flows alem do limite, mas impede ativacao se exceder o limite do plano"
    },
    "versioning": {
      "immutable": "Versoes sao imutaveis apos ativacao",
      "oneActive": "Apenas uma versao pode estar ativa por flow",
      "draftEditable": "Apenas versoes DRAFT podem ser editadas"
    },
    "templates": {
      "notExecutable": "Templates nao sao executaveis",
      "copyIndependent": "Criar flow de template gera copia independente"
    },
    "cardCompatibility": {
      "TEST": "Suporta ASSERT, EVIDENCE, ERROR (exclusivos)",
      "PROGRAM_FLOW": "Suporta CONDITION, LOOP, STATE (exclusivos)",
      "PROCESS": "Todos os cards comuns (START, END, ACTION, etc)"
    }
  }
}
