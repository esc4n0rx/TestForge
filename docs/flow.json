{
  "apiVersion": "1.0.0",
  "title": "TestForge - Flow API",
  "description": "API completa para gerenciamento de Flows (fluxos de teste, processos e program flows)",
  "baseUrl": "/api/flows",

  "features": {
    "flow_versioning": "Versionamento e rollback de flows (Team/Enterprise)",
    "flow_execution_logs": "Logs de execução de flows (Team/Enterprise)",
    "flow_export": "Exportação de flows para PDF/CSV (Team/Enterprise)",
    "flow_templates": "Templates reutilizáveis (Start: 5, Team/Enterprise: ilimitado)",
    "flow_environments": "Ambientes separados DEV/QA/PROD (Enterprise only)"
  },

  "limits": {
    "forge_start": {
      "max_flows": 10,
      "flow_versioning": false,
      "flow_execution_logs": false,
      "flow_export": false,
      "flow_templates": 5,
      "flow_environments": false
    },
    "forge_team": {
      "max_flows": -1,
      "flow_versioning": true,
      "flow_execution_logs": true,
      "flow_export": true,
      "flow_templates": -1,
      "flow_environments": false
    },
    "forge_enterprise": {
      "max_flows": -1,
      "flow_versioning": true,
      "flow_execution_logs": true,
      "flow_export": true,
      "flow_templates": -1,
      "flow_environments": true
    }
  },

  "flowTypes": {
    "TEST": "Flow de teste (QA) - suporta ASSERT, EVIDENCE, ERROR",
    "PROGRAM_FLOW": "Fluxo lógico de software - suporta CONDITION, LOOP, STATE",
    "PROCESS": "Fluxo de processo de negócio"
  },

  "cardTypes": {
    "structural": ["START", "END"],
    "action": ["ACTION", "EVENT"],
    "decision": ["DECISION", "ASSERT"],
    "evidence": ["EVIDENCE", "ERROR"],
    "technical": ["CONDITION", "LOOP", "STATE"],
    "documentation": ["COMMENT", "TECH_NOTE"]
  },

  "endpoints": {
    "public": {
      "getFlowForExecution": {
        "method": "GET",
        "path": "/public/:flowId",
        "auth": false,
        "description": "Busca flow ativo para execução pública",
        "params": { "flowId": "number" },
        "response": {
          "success": true,
          "data": {
            "flow": "FlowWithDetails (inclui currentVersion com todos os cards e anexos)"
          }
        },
        "errors": ["FLOW_NOT_FOUND", "FLOW_NOT_ACTIVE", "CANNOT_EXECUTE_TEMPLATE"]
      },
      "startExecution": {
        "method": "POST",
        "path": "/public/:flowId/execute",
        "auth": false,
        "description": "Inicia execução de flow",
        "params": { "flowId": "number" },
        "body": {
          "executedBy": "number (opcional - userId)",
          "clientEmail": "string (opcional - email do cliente)"
        },
        "response": {
          "success": true,
          "data": {
            "flow": "FlowWithDetails",
            "execution": "FlowExecution | null (null se plano não tem logs)"
          }
        }
      },
      "updateExecution": {
        "method": "PATCH",
        "path": "/executions/:executionId",
        "auth": false,
        "description": "Atualiza status/notas de execução",
        "body": {
          "status": "IN_PROGRESS | COMPLETED | FAILED",
          "notes": "string",
          "completedAt": "ISO datetime"
        }
      },
      "recordCardExecution": {
        "method": "POST",
        "path": "/executions/:executionId/cards/:cardId",
        "auth": false,
        "description": "Registra execução de um card específico",
        "body": {
          "status": "PENDING | PASSED | FAILED | SKIPPED",
          "notes": "string",
          "attachments": "string (JSON array de URLs)"
        }
      }
    },

    "flows": {
      "list": {
        "method": "GET",
        "path": "/",
        "auth": true,
        "middleware": ["requireAuth", "requireValidSubscription"],
        "description": "Lista flows do workspace",
        "query": {
          "type": "TEST | PROGRAM_FLOW | PROCESS",
          "environment": "NONE | DEV | QA | STAGING | PRODUCTION",
          "isTemplate": "boolean",
          "spaceId": "number"
        },
        "response": {
          "success": true,
          "data": { "flows": "FlowWithDetails[]" }
        }
      },
      "create": {
        "method": "POST",
        "path": "/",
        "auth": true,
        "middleware": ["requireAuth", "requireValidSubscription", "requireModifyPermission"],
        "permissions": ["OWNER", "ADMIN", "MEMBER"],
        "description": "Cria novo flow",
        "body": {
          "name": "string (required, 2-200 chars)",
          "description": "string (optional, max 1000)",
          "type": "TEST | PROGRAM_FLOW | PROCESS (required)",
          "environment": "NONE | DEV | QA | STAGING | PRODUCTION (default: NONE)",
          "isTemplate": "boolean (default: false)",
          "spaceId": "number (optional)"
        },
        "validations": [
          "Limite de flows ativos (permite criar além do limite, mas impede ativação)",
          "Limite de templates (bloqueia criação se exceder)",
          "Ambiente requer feature flow_environments (Enterprise)",
          "SpaceId deve pertencer ao workspace"
        ],
        "response": {
          "success": true,
          "data": { "flow": "FlowWithDetails" }
        },
        "errors": [
          "WORKSPACE_NOT_FOUND",
          "NOT_WORKSPACE_MEMBER",
          "TEMPLATE_LIMIT_EXCEEDED",
          "ENVIRONMENTS_NOT_AVAILABLE",
          "SPACE_NOT_FOUND"
        ]
      },
      "get": {
        "method": "GET",
        "path": "/:flowId",
        "auth": true,
        "middleware": ["requireAuth", "requireValidSubscription", "validateFlowAccess"],
        "permissions": ["OWNER", "ADMIN", "MEMBER"],
        "description": "Busca flow por ID com versão atual e cards",
        "response": {
          "success": true,
          "data": { "flow": "FlowWithDetails" }
        }
      },
      "update": {
        "method": "PATCH",
        "path": "/:flowId",
        "auth": true,
        "middleware": ["requireAuth", "requireValidSubscription", "requireModifyPermission", "validateFlowAccess"],
        "permissions": ["OWNER", "ADMIN", "MEMBER"],
        "description": "Atualiza flow",
        "body": {
          "name": "string (optional, 2-200)",
          "description": "string (optional, max 1000)",
          "environment": "NONE | DEV | QA | STAGING | PRODUCTION"
        }
      },
      "delete": {
        "method": "DELETE",
        "path": "/:flowId",
        "auth": true,
        "middleware": ["requireAuth", "requireValidSubscription", "requireModifyPermission", "validateFlowAccess", "validateFlowDeletePermission"],
        "permissions": ["OWNER", "ADMIN"],
        "description": "Deleta flow (soft delete - marca versão atual como DELETED)"
      }
    },

    "versioning": {
      "list": {
        "method": "GET",
        "path": "/:flowId/versions",
        "auth": true,
        "feature": "flow_versioning",
        "middleware": ["requireAuth", "requireValidSubscription", "requireFeature('flow_versioning')", "validateFlowAccess"],
        "permissions": ["OWNER", "ADMIN", "MEMBER"],
        "description": "Lista todas as versões de um flow"
      },
      "create": {
        "method": "POST",
        "path": "/:flowId/versions",
        "auth": true,
        "feature": "flow_versioning",
        "middleware": ["requireAuth", "requireValidSubscription", "requireModifyPermission", "requireFeature('flow_versioning')", "validateFlowAccess", "validateFlowModifyPermission"],
        "permissions": ["OWNER", "ADMIN"],
        "description": "Cria nova versão duplicando a versão atual",
        "body": {
          "changeLog": "string (optional, max 500)"
        },
        "validations": [
          "Requer plano Team ou Enterprise",
          "Versão atual deve existir"
        ],
        "errors": [
          "VERSIONING_NOT_AVAILABLE",
          "NO_CURRENT_VERSION"
        ]
      },
      "activate": {
        "method": "POST",
        "path": "/:flowId/versions/:versionId/activate",
        "auth": true,
        "feature": "flow_versioning",
        "middleware": ["requireAuth", "requireValidSubscription", "requireModifyPermission", "requireFeature('flow_versioning')", "validateFlowAccess", "validateFlowModifyPermission"],
        "permissions": ["OWNER", "ADMIN"],
        "description": "Ativa uma versão específica (rollback)",
        "validations": [
          "Versão deve pertencer ao flow",
          "Valida limite de flows ativos antes de ativar"
        ],
        "errors": [
          "VERSION_NOT_FOUND",
          "ACTIVE_FLOW_LIMIT_EXCEEDED"
        ]
      },
      "deactivate": {
        "method": "POST",
        "path": "/:flowId/deactivate",
        "auth": true,
        "middleware": ["requireAuth", "requireValidSubscription", "requireModifyPermission", "validateFlowAccess", "validateFlowModifyPermission"],
        "permissions": ["OWNER", "ADMIN"],
        "description": "Desativa flow (coloca em DRAFT)"
      }
    },

    "cards": {
      "add": {
        "method": "POST",
        "path": "/versions/:versionId/cards",
        "auth": true,
        "middleware": ["requireAuth", "requireValidSubscription", "requireModifyPermission"],
        "permissions": ["OWNER", "ADMIN", "MEMBER"],
        "description": "Adiciona card a uma versão",
        "body": {
          "type": "CardType (required)",
          "title": "string (optional, max 200)",
          "content": "string (optional, max 5000)",
          "notes": "string (optional, max 2000)",
          "positionX": "number (default: 0)",
          "positionY": "number (default: 0)",
          "connections": "number[] (IDs de outros cards)"
        },
        "validations": [
          "Versão não pode estar ACTIVE",
          "Tipo de card deve ser compatível com tipo de flow",
          "ASSERT, EVIDENCE, ERROR apenas em TEST",
          "CONDITION, LOOP, STATE apenas em PROGRAM_FLOW"
        ],
        "errors": [
          "VERSION_NOT_FOUND",
          "CANNOT_EDIT_ACTIVE_VERSION",
          "CARD_TYPE_NOT_ALLOWED_FOR_FLOW_TYPE"
        ]
      },
      "update": {
        "method": "PATCH",
        "path": "/cards/:cardId",
        "auth": true,
        "middleware": ["requireAuth", "requireValidSubscription", "requireModifyPermission"],
        "permissions": ["OWNER", "ADMIN", "MEMBER"],
        "description": "Atualiza card",
        "body": {
          "title": "string",
          "content": "string",
          "notes": "string",
          "positionX": "number",
          "positionY": "number",
          "connections": "number[]"
        },
        "validations": ["Versão não pode estar ACTIVE"]
      },
      "delete": {
        "method": "DELETE",
        "path": "/cards/:cardId",
        "auth": true,
        "middleware": ["requireAuth", "requireValidSubscription", "requireModifyPermission"],
        "permissions": ["OWNER", "ADMIN"],
        "description": "Deleta card e seus anexos",
        "validations": [
          "Versão não pode estar ACTIVE",
          "Deleta anexos do Cloudinary automaticamente"
        ]
      }
    },

    "attachments": {
      "upload": {
        "method": "POST",
        "path": "/cards/:cardId/attachments",
        "auth": true,
        "middleware": ["requireAuth", "requireValidSubscription", "requireModifyPermission", "upload.single('file')"],
        "permissions": ["OWNER", "ADMIN", "MEMBER"],
        "description": "Upload de anexo (imagem) para card",
        "contentType": "multipart/form-data",
        "body": {
          "file": "File (image/png, image/jpeg, image/jpg, image/webp, image/gif)"
        },
        "validations": [
          "Apenas imagens permitidas",
          "Máximo 25MB por arquivo",
          "Conversão automática para WebP",
          "Upload para Cloudinary: forge/workspace_{id}/flow_{id}/card_{id}/"
        ],
        "response": {
          "success": true,
          "data": { "attachment": "FlowAttachment" }
        },
        "errors": [
          "INVALID_FILE_TYPE",
          "FILE_SIZE_LIMIT_EXCEEDED",
          "UPLOAD_FAILED"
        ]
      },
      "delete": {
        "method": "DELETE",
        "path": "/attachments/:attachmentId",
        "auth": true,
        "middleware": ["requireAuth", "requireValidSubscription", "requireModifyPermission"],
        "permissions": ["OWNER", "ADMIN"],
        "description": "Deleta anexo do card (remove do Cloudinary e banco)"
      }
    },

    "templates": {
      "createFromTemplate": {
        "method": "POST",
        "path": "/templates/:templateId/create-flow",
        "auth": true,
        "middleware": ["requireAuth", "requireValidSubscription", "requireModifyPermission"],
        "permissions": ["OWNER", "ADMIN", "MEMBER"],
        "description": "Cria novo flow a partir de template",
        "body": {
          "name": "string (optional - senão usa nome do template + ' (Cópia)')"
        },
        "validations": [
          "Template deve existir e ter isTemplate=true",
          "Valida limite de flows do workspace",
          "Copia todos os cards da versão atual do template"
        ],
        "errors": [
          "TEMPLATE_NOT_FOUND",
          "NOT_WORKSPACE_MEMBER"
        ]
      }
    }
  },

  "dataModels": {
    "Flow": {
      "id": "number",
      "workspaceId": "number",
      "spaceId": "number | null",
      "name": "string",
      "description": "string | null",
      "type": "FlowType",
      "environment": "FlowEnvironment",
      "isTemplate": "boolean",
      "currentVersionId": "number | null",
      "versionCount": "number",
      "createdBy": "number",
      "createdAt": "datetime",
      "updatedAt": "datetime"
    },
    "FlowVersion": {
      "id": "number",
      "flowId": "number",
      "versionNumber": "number",
      "status": "DRAFT | ACTIVE | DELETED",
      "name": "string",
      "description": "string | null",
      "type": "FlowType",
      "changeLog": "string | null",
      "createdBy": "number",
      "createdAt": "datetime"
    },
    "FlowCard": {
      "id": "number",
      "versionId": "number",
      "type": "CardType",
      "title": "string | null",
      "content": "string | null",
      "notes": "string | null",
      "positionX": "number",
      "positionY": "number",
      "connections": "string (JSON array)",
      "createdAt": "datetime"
    },
    "FlowAttachment": {
      "id": "number",
      "cardId": "number",
      "provider": "string ('cloudinary')",
      "publicId": "string",
      "secureUrl": "string",
      "originalName": "string",
      "originalFormat": "string",
      "storedFormat": "string ('webp')",
      "bytes": "number",
      "width": "number | null",
      "height": "number | null",
      "uploadedBy": "number",
      "createdAt": "datetime"
    },
    "FlowExecution": {
      "id": "number",
      "flowId": "number",
      "versionId": "number",
      "executedBy": "number | null",
      "clientEmail": "string | null",
      "status": "string (IN_PROGRESS | COMPLETED | FAILED)",
      "startedAt": "datetime",
      "completedAt": "datetime | null",
      "notes": "string | null",
      "evidencesCount": "number"
    },
    "CardExecution": {
      "id": "number",
      "executionId": "number",
      "cardId": "number",
      "status": "string (PENDING | PASSED | FAILED | SKIPPED)",
      "notes": "string | null",
      "attachments": "string | null (JSON array)",
      "executedAt": "datetime"
    }
  },

  "businessRules": {
    "permissions": {
      "OWNER": "Todas as ações",
      "ADMIN": "Criar, editar, versionar, ativar/desativar, deletar",
      "MEMBER": "Criar e editar flows e cards"
    },
    "flowCreation": {
      "note": "Sistema permite criar flows além do limite, mas impede ativação se exceder o limite do plano"
    },
    "versioning": {
      "immutable": "Versões são imutáveis após criação",
      "oneActive": "Apenas uma versão pode estar ativa por flow",
      "rollback": "Rollback cria nova versão baseada em versão anterior"
    },
    "templates": {
      "notExecutable": "Templates não são executáveis",
      "copyIndependent": "Criar flow de template gera cópia independente"
    },
    "cardCompatibility": {
      "TEST": "Suporta ASSERT, EVIDENCE, ERROR",
      "PROGRAM_FLOW": "Suporta CONDITION, LOOP, STATE",
      "PROCESS": "Todos os cards comuns (START, END, ACTION, etc)"
    }
  },

  "integrations": {
    "cloudinary": {
      "folder": "forge/workspace_{workspaceId}/flow_{flowId}/card_{cardId}/",
      "format": "webp (conversão automática)",
      "naming": "{timestamp}_{uuid}.webp",
      "maxSize": "25MB",
      "allowedTypes": ["image/png", "image/jpeg", "image/jpg", "image/webp", "image/gif"]
    }
  },

  "export": {
    "description": "Sistema de exportação para planos Team e Enterprise",
    "formats": {
      "pdf": {
        "description": "Documento PDF profissional",
        "library": "pdfkit",
        "features": [
          "Cabeçalho formatado com título do flow",
          "Informações completas do flow (tipo, ambiente, workspace, etc)",
          "Lista detalhada de cards com título, conteúdo, notas",
          "Informações de anexos (nome, tamanho)",
          "Histórico de versões (opcional)",
          "Rodapé com data de exportação",
          "Paginação automática"
        ]
      },
      "csv": {
        "description": "Arquivo CSV para planilhas",
        "library": "csv-stringify",
        "features": [
          "Exportação individual: uma linha por card",
          "Exportação múltipla: uma linha por flow (resumo)",
          "Colunas com informações estruturadas",
          "Compatível com Excel, Google Sheets, etc"
        ]
      }
    },
    "endpoints": {
      "single": "GET /api/flows/:flowId/export?format=pdf&includeCards=true&includeAttachments=true&includeVersionHistory=false",
      "multiple": "GET /api/flows/export/multiple?flowIds=1,2,3"
    },
    "validation": {
      "feature": "flow_export",
      "plans": ["Team", "Enterprise"],
      "permissions": ["OWNER", "ADMIN", "MEMBER"]
    }
  }
}
