{
  "title": "Spaces & Storage API",
  "description": "API para gerenciamento de Spaces (espaços de armazenamento de evidências) e upload de arquivos (imagens)",
  "version": "1.1.0",
  "lastUpdated": "2026-01-18",
  "baseUrl": "/api/spaces",
  "authentication": "Todas as rotas requerem autenticação via sessão (cookie: testforge.sid)",

  "importantNotes": [
    "CRITICO: O baseUrl é /api/spaces (não /spaces)",
    "CRITICO: Para exibir 'X de Y evidencias', use GET /api/spaces/stats?workspaceId={id}",
    "CRITICO: O campo para total de arquivos é response.data.stats.totalFiles",
    "CRITICO: O campo para limite do plano é response.data.stats.limit",
    "Todos arquivos são convertidos para WebP automaticamente",
    "O campo _count.files nos spaces é util para mostrar contagem por space"
  ],

  "features": {
    "max_evidences": {
      "description": "Número máximo de evidências (arquivos) que podem ser armazenadas por workspace",
      "type": "NUMERIC",
      "plans": {
        "forge_start": 200,
        "forge_team": 500,
        "forge_enterprise": 2000
      }
    },
    "retention_days": {
      "description": "Número de dias que evidências são mantidas antes de serem removidas automaticamente",
      "type": "NUMERIC",
      "plans": {
        "forge_start": 7,
        "forge_team": 30,
        "forge_enterprise": -1
      },
      "note": "-1 significa sem retenção automática (não deletar)"
    }
  },

  "fileUploadRules": {
    "maxFileSize": "25MB (26214400 bytes)",
    "allowedMimeTypes": [
      "image/png",
      "image/jpeg",
      "image/jpg",
      "image/webp",
      "image/gif"
    ],
    "storedFormat": "webp (todos os arquivos são convertidos automaticamente)",
    "namingPattern": "{timestamp}_{uuid}.webp",
    "cloudinaryFolder": "forge/workspace_{workspaceId}/space_{spaceId}/"
  },

  "endpoints": [
    {
      "method": "GET",
      "path": "/api/spaces/stats?workspaceId={workspaceId}",
      "description": "Retorna estatísticas de storage do workspace - USE PARA EXIBIR 'X de Y evidencias'",
      "permissions": ["OWNER", "ADMIN", "MEMBER"],
      "queryParams": {
        "workspaceId": "number (required)"
      },
      "realResponse": {
        "success": true,
        "data": {
          "stats": {
            "totalFiles": 1,
            "totalBytes": 306,
            "totalMB": "0.00",
            "totalGB": "0.00",
            "limit": 200,
            "remaining": 199,
            "percentageUsed": 1
          }
        }
      },
      "frontendUsage": {
        "description": "Como extrair dados para exibir 'X de Y evidencias'",
        "code": "const { totalFiles, limit, remaining, percentageUsed } = response.data.stats;\n// Exibir: `${totalFiles} de ${limit} evidencias`\n// Ou: `${totalFiles}/${limit} (${percentageUsed}%)`"
      },
      "errors": {
        "400": {
          "success": false,
          "error": {
            "message": "workspaceId é obrigatório",
            "code": "VALIDATION_ERROR"
          }
        },
        "403": {
          "success": false,
          "error": {
            "message": "Você não tem acesso a este workspace",
            "code": "FORBIDDEN"
          }
        }
      }
    },
    {
      "method": "GET",
      "path": "/api/spaces?workspaceId={workspaceId}",
      "description": "Lista spaces de um workspace",
      "permissions": ["OWNER", "ADMIN", "MEMBER"],
      "queryParams": {
        "workspaceId": "number (required)"
      },
      "realResponse": {
        "success": true,
        "data": {
          "spaces": [
            {
              "id": 1,
              "workspaceId": 7,
              "name": "Testes",
              "description": "Space de Teste",
              "createdBy": 12,
              "createdAt": "2026-01-16T19:54:15.795Z",
              "updatedAt": "2026-01-16T19:54:15.795Z",
              "files": [],
              "_count": {
                "files": 0
              }
            }
          ]
        }
      },
      "frontendUsage": {
        "description": "Como extrair lista de spaces",
        "code": "const spaces = response.data.spaces;\nspaces.forEach(space => {\n  console.log(`${space.name}: ${space._count.files} arquivos`);\n});"
      },
      "errors": {
        "400": {
          "success": false,
          "error": {
            "message": "workspaceId é obrigatório",
            "code": "VALIDATION_ERROR"
          }
        },
        "403": {
          "success": false,
          "error": {
            "message": "Você não tem acesso a este workspace",
            "code": "FORBIDDEN"
          }
        }
      }
    },
    {
      "method": "POST",
      "path": "/api/spaces",
      "description": "Cria um novo space",
      "permissions": ["OWNER", "ADMIN", "MEMBER"],
      "requestBody": {
        "workspaceId": "number (required)",
        "name": "string (required, min: 2, max: 100)",
        "description": "string (optional, max: 500)"
      },
      "requestExample": {
        "workspaceId": 7,
        "name": "Evidencias SAP",
        "description": "Space para evidencias de testes SAP"
      },
      "realResponse": {
        "success": true,
        "data": {
          "space": {
            "id": 1,
            "workspaceId": 7,
            "name": "Evidencias SAP",
            "description": "Space para evidencias de testes SAP",
            "createdBy": 10,
            "createdAt": "2026-01-18T18:41:45.000Z",
            "updatedAt": "2026-01-18T18:41:45.000Z",
            "files": [],
            "_count": {
              "files": 0
            }
          }
        }
      },
      "frontendUsage": {
        "description": "Como criar space",
        "code": "const newSpace = response.data.space;\nconsole.log(`Space criado: ${newSpace.id}`);"
      },
      "errors": {
        "400": {
          "success": false,
          "error": {
            "message": "Dados inválidos",
            "code": "VALIDATION_ERROR",
            "details": []
          }
        },
        "401": {
          "success": false,
          "error": {
            "message": "Autenticação necessária",
            "code": "UNAUTHORIZED"
          }
        },
        "403": {
          "success": false,
          "error": {
            "message": "Você não é membro deste workspace",
            "code": "FORBIDDEN"
          }
        },
        "404": {
          "success": false,
          "error": {
            "message": "Workspace não encontrado",
            "code": "WORKSPACE_NOT_FOUND"
          }
        }
      }
    },
    {
      "method": "GET",
      "path": "/api/spaces/:id",
      "description": "Busca um space por ID",
      "permissions": ["OWNER", "ADMIN", "MEMBER"],
      "params": {
        "id": "number"
      },
      "realResponse": {
        "success": true,
        "data": {
          "space": {
            "id": 1,
            "workspaceId": 7,
            "name": "Testes",
            "description": "Space de Teste",
            "createdBy": 12,
            "createdAt": "2026-01-16T19:54:15.795Z",
            "updatedAt": "2026-01-16T19:54:15.795Z",
            "files": [],
            "_count": {
              "files": 0
            }
          }
        }
      },
      "frontendUsage": {
        "description": "Como extrair space",
        "code": "const space = response.data.space;\nconst fileCount = space._count.files;"
      },
      "errors": {
        "403": {
          "success": false,
          "error": {
            "message": "Você não tem acesso a este space",
            "code": "FORBIDDEN"
          }
        },
        "404": {
          "success": false,
          "error": {
            "message": "Space não encontrado",
            "code": "SPACE_NOT_FOUND"
          }
        }
      }
    },
    {
      "method": "PUT",
      "path": "/api/spaces/:id",
      "description": "Atualiza um space",
      "permissions": ["OWNER", "ADMIN"],
      "params": {
        "id": "number"
      },
      "requestBody": {
        "name": "string (optional, min: 2, max: 100)",
        "description": "string (optional, max: 500)"
      },
      "requestExample": {
        "name": "Evidencias SAP - Atualizado",
        "description": "Descricao atualizada"
      },
      "realResponse": {
        "success": true,
        "data": {
          "space": {
            "id": 1,
            "workspaceId": 7,
            "name": "Evidencias SAP - Atualizado 154145",
            "description": "Descricao atualizada para testes",
            "createdBy": 12,
            "createdAt": "2026-01-16T19:54:15.795Z",
            "updatedAt": "2026-01-18T18:41:46.122Z",
            "files": [
              {
                "id": 1,
                "spaceId": 1,
                "workspaceId": 7,
                "uploadedBy": 10,
                "provider": "cloudinary",
                "publicId": "forge/workspace_7/space_1/1768761704047_63db85d7",
                "secureUrl": "https://res.cloudinary.com/dzswuvjbl/image/upload/v1768761704/forge/workspace_7/space_1/1768761704047_63db85d7.webp",
                "originalName": "testforge-test-image.png",
                "originalFormat": "png",
                "storedFormat": "webp",
                "bytes": 306,
                "width": 100,
                "height": 100,
                "createdAt": "2026-01-18T18:41:45.511Z"
              }
            ],
            "_count": {
              "files": 1
            }
          }
        }
      },
      "frontendUsage": {
        "description": "Como atualizar space",
        "code": "const updatedSpace = response.data.space;"
      },
      "errors": {
        "400": {
          "success": false,
          "error": {
            "message": "Dados inválidos",
            "code": "VALIDATION_ERROR"
          }
        },
        "403": {
          "success": false,
          "error": {
            "message": "Você não tem permissão para atualizar este space",
            "code": "FORBIDDEN"
          }
        },
        "404": {
          "success": false,
          "error": {
            "message": "Space não encontrado",
            "code": "SPACE_NOT_FOUND"
          }
        }
      }
    },
    {
      "method": "DELETE",
      "path": "/api/spaces/:id",
      "description": "Deleta um space e todos os seus arquivos",
      "permissions": ["OWNER"],
      "note": "Remove todos os arquivos do Cloudinary antes de deletar o space do banco",
      "params": {
        "id": "number"
      },
      "realResponse": {
        "success": true,
        "data": {
          "message": "Space deletado com sucesso"
        }
      },
      "errors": {
        "403": {
          "success": false,
          "error": {
            "message": "Apenas o OWNER do workspace pode deletar spaces",
            "code": "FORBIDDEN"
          }
        },
        "404": {
          "success": false,
          "error": {
            "message": "Space não encontrado",
            "code": "SPACE_NOT_FOUND"
          }
        }
      }
    },
    {
      "method": "POST",
      "path": "/api/spaces/:spaceId/files",
      "description": "Faz upload de arquivo (imagem) para o space",
      "permissions": ["OWNER", "ADMIN", "MEMBER"],
      "contentType": "multipart/form-data",
      "params": {
        "spaceId": "number"
      },
      "formData": {
        "file": "File (required, max: 25MB, types: PNG, JPG, JPEG, WEBP, GIF)"
      },
      "validations": [
        "Workspace deve ter assinatura ACTIVE ou TRIALING",
        "Limite de evidências do plano não pode ser excedido",
        "Tipo de arquivo deve ser imagem (PNG, JPG, JPEG, WEBP, GIF)",
        "Tamanho do arquivo não pode exceder 25MB"
      ],
      "realResponse": {
        "success": true,
        "data": {
          "file": {
            "id": 1,
            "spaceId": 1,
            "workspaceId": 7,
            "uploadedBy": 10,
            "provider": "cloudinary",
            "publicId": "forge/workspace_7/space_1/1768761704047_63db85d7",
            "secureUrl": "https://res.cloudinary.com/dzswuvjbl/image/upload/v1768761704/forge/workspace_7/space_1/1768761704047_63db85d7.webp",
            "originalName": "testforge-test-image.png",
            "originalFormat": "png",
            "storedFormat": "webp",
            "bytes": 306,
            "width": 100,
            "height": 100,
            "createdAt": "2026-01-18T18:41:45.511Z"
          },
          "message": "Arquivo enviado com sucesso"
        }
      },
      "frontendUsage": {
        "description": "Como fazer upload e extrair dados",
        "code": "const formData = new FormData();\nformData.append('file', selectedFile);\n\nconst response = await fetch(`/api/spaces/${spaceId}/files`, {\n  method: 'POST',\n  credentials: 'include',\n  body: formData\n});\n\nconst data = await response.json();\nif (data.success) {\n  const uploadedFile = data.data.file;\n  const imageUrl = uploadedFile.secureUrl;\n  console.log(`Upload OK: ${imageUrl}`);\n}"
      },
      "errors": {
        "400": {
          "NO_FILE": {
            "success": false,
            "error": {
              "message": "Nenhum arquivo foi enviado",
              "code": "NO_FILE"
            }
          },
          "INVALID_FILE_TYPE": {
            "success": false,
            "error": {
              "message": "Tipo de arquivo não permitido",
              "code": "INVALID_FILE_TYPE",
              "details": {
                "receivedType": "application/pdf",
                "allowedTypes": ["image/png", "image/jpeg", "image/webp", "image/gif"]
              }
            }
          },
          "FILE_SIZE_LIMIT_EXCEEDED": {
            "success": false,
            "error": {
              "message": "Arquivo muito grande",
              "code": "FILE_SIZE_LIMIT_EXCEEDED",
              "details": {
                "fileSize": 30000000,
                "maxSize": 26214400
              }
            }
          }
        },
        "403": {
          "LIMIT_REACHED": {
            "success": false,
            "error": {
              "message": "Limite de evidências atingido",
              "code": "LIMIT_REACHED",
              "details": {
                "current": 200,
                "limit": 200
              }
            }
          },
          "NO_ACTIVE_SUBSCRIPTION": {
            "success": false,
            "error": {
              "message": "Workspace sem assinatura ativa",
              "code": "NO_ACTIVE_SUBSCRIPTION"
            }
          }
        },
        "404": {
          "success": false,
          "error": {
            "message": "Space não encontrado",
            "code": "SPACE_NOT_FOUND"
          }
        },
        "500": {
          "success": false,
          "error": {
            "message": "Falha ao fazer upload do arquivo",
            "code": "UPLOAD_FAILED"
          }
        }
      }
    },
    {
      "method": "GET",
      "path": "/api/spaces/:spaceId/files",
      "description": "Lista arquivos de um space",
      "permissions": ["OWNER", "ADMIN", "MEMBER"],
      "params": {
        "spaceId": "number"
      },
      "queryParams": {
        "limit": "number (optional, default: 20, max: 100)",
        "offset": "number (optional, default: 0)"
      },
      "realResponse": {
        "success": true,
        "data": {
          "files": [
            {
              "id": 1,
              "spaceId": 1,
              "workspaceId": 7,
              "uploadedBy": 10,
              "provider": "cloudinary",
              "publicId": "forge/workspace_7/space_1/1768761704047_63db85d7",
              "secureUrl": "https://res.cloudinary.com/dzswuvjbl/image/upload/v1768761704/forge/workspace_7/space_1/1768761704047_63db85d7.webp",
              "originalName": "testforge-test-image.png",
              "originalFormat": "png",
              "storedFormat": "webp",
              "bytes": 306,
              "width": 100,
              "height": 100,
              "createdAt": "2026-01-18T18:41:45.511Z"
            }
          ]
        }
      },
      "frontendUsage": {
        "description": "Como listar arquivos",
        "code": "const files = response.data.files;\nfiles.forEach(file => {\n  console.log(`${file.originalName}: ${file.secureUrl}`);\n});"
      },
      "errors": {
        "400": {
          "success": false,
          "error": {
            "message": "Parâmetros inválidos",
            "code": "VALIDATION_ERROR"
          }
        },
        "403": {
          "success": false,
          "error": {
            "message": "Você não tem acesso a este space",
            "code": "FORBIDDEN"
          }
        },
        "404": {
          "success": false,
          "error": {
            "message": "Space não encontrado",
            "code": "SPACE_NOT_FOUND"
          }
        }
      }
    },
    {
      "method": "GET",
      "path": "/api/spaces/:spaceId/files/:fileId",
      "description": "Busca arquivo por ID",
      "permissions": ["OWNER", "ADMIN", "MEMBER"],
      "params": {
        "spaceId": "number",
        "fileId": "number"
      },
      "realResponse": {
        "success": true,
        "data": {
          "file": {
            "id": 1,
            "spaceId": 1,
            "workspaceId": 7,
            "uploadedBy": 10,
            "provider": "cloudinary",
            "publicId": "forge/workspace_7/space_1/1768761704047_63db85d7",
            "secureUrl": "https://res.cloudinary.com/dzswuvjbl/image/upload/v1768761704/forge/workspace_7/space_1/1768761704047_63db85d7.webp",
            "originalName": "testforge-test-image.png",
            "originalFormat": "png",
            "storedFormat": "webp",
            "bytes": 306,
            "width": 100,
            "height": 100,
            "createdAt": "2026-01-18T18:41:45.511Z"
          }
        }
      },
      "frontendUsage": {
        "description": "Como buscar arquivo",
        "code": "const file = response.data.file;\nconst imageUrl = file.secureUrl;"
      },
      "errors": {
        "403": {
          "success": false,
          "error": {
            "message": "Você não tem acesso a este arquivo",
            "code": "FORBIDDEN"
          }
        },
        "404": {
          "success": false,
          "error": {
            "message": "Arquivo não encontrado",
            "code": "FILE_NOT_FOUND"
          }
        }
      }
    },
    {
      "method": "DELETE",
      "path": "/api/spaces/:spaceId/files/:fileId",
      "description": "Deleta arquivo",
      "permissions": ["OWNER", "ADMIN"],
      "note": "Remove o arquivo do Cloudinary e do banco de dados",
      "params": {
        "spaceId": "number",
        "fileId": "number"
      },
      "realResponse": {
        "success": true,
        "data": {
          "success": true,
          "message": "Arquivo deletado com sucesso"
        }
      },
      "errors": {
        "403": {
          "success": false,
          "error": {
            "message": "Você não tem permissão para deletar este arquivo",
            "code": "FORBIDDEN"
          }
        },
        "404": {
          "success": false,
          "error": {
            "message": "Arquivo não encontrado",
            "code": "FILE_NOT_FOUND"
          }
        }
      }
    }
  ],

  "frontendHelpers": {
    "typescript": {
      "interfaces": "// Interfaces TypeScript\n\ninterface StorageStats {\n  totalFiles: number;\n  totalBytes: number;\n  totalMB: string;\n  totalGB: string;\n  limit: number;\n  remaining: number;\n  percentageUsed: number;\n}\n\ninterface Space {\n  id: number;\n  workspaceId: number;\n  name: string;\n  description: string | null;\n  createdBy: number;\n  createdAt: string;\n  updatedAt: string;\n  files: SpaceFile[];\n  _count: { files: number };\n}\n\ninterface SpaceFile {\n  id: number;\n  spaceId: number;\n  workspaceId: number;\n  uploadedBy: number;\n  provider: string;\n  publicId: string;\n  secureUrl: string;\n  originalName: string;\n  originalFormat: string;\n  storedFormat: string;\n  bytes: number;\n  width: number | null;\n  height: number | null;\n  createdAt: string;\n}",
      "getStorageStats": "async function getStorageStats(workspaceId: number): Promise<StorageStats> {\n  const response = await fetch(`/api/spaces/stats?workspaceId=${workspaceId}`, {\n    credentials: 'include'\n  });\n  const data = await response.json();\n  if (!data.success) throw new Error(data.error.message);\n  return data.data.stats;\n}",
      "getSpaces": "async function getSpaces(workspaceId: number): Promise<Space[]> {\n  const response = await fetch(`/api/spaces?workspaceId=${workspaceId}`, {\n    credentials: 'include'\n  });\n  const data = await response.json();\n  if (!data.success) throw new Error(data.error.message);\n  return data.data.spaces;\n}",
      "uploadFile": "async function uploadFile(spaceId: number, file: File): Promise<SpaceFile> {\n  const formData = new FormData();\n  formData.append('file', file);\n  \n  const response = await fetch(`/api/spaces/${spaceId}/files`, {\n    method: 'POST',\n    credentials: 'include',\n    body: formData\n  });\n  \n  const data = await response.json();\n  if (!data.success) throw new Error(data.error.message);\n  return data.data.file;\n}",
      "displayUsage": "// Exibir uso de evidencias\nconst stats = await getStorageStats(workspaceId);\nconst usageText = `${stats.totalFiles} de ${stats.limit} evidências`;\nconst progressPercent = stats.percentageUsed;\nconsole.log(usageText); // \"1 de 200 evidências\""
    }
  },

  "cronJobs": [
    {
      "name": "cleanup-expired-files",
      "description": "Remove automaticamente arquivos que ultrapassaram o período de retenção configurado no plano",
      "schedule": "Diariamente às 2 AM (recomendado)",
      "command": "npm run cleanup:expired-files",
      "logic": [
        "1. Busca todos os workspaces ativos com assinatura (ACTIVE, TRIALING, PAST_DUE)",
        "2. Para cada workspace, obtém o retention_days do plano",
        "3. Se retention_days = -1, não deleta (sem retenção automática)",
        "4. Calcula data de expiração: hoje - retention_days",
        "5. Busca todos os arquivos do workspace com createdAt < data de expiração",
        "6. Deleta cada arquivo do Cloudinary (via publicId)",
        "7. Deleta cada arquivo do banco de dados",
        "8. Registra logs de sucesso/erro"
      ],
      "logs": {
        "success": "Total de arquivos processados, deletados e por workspace",
        "error": "Lista de erros encontrados durante o cleanup"
      }
    }
  ],

  "errorCodes": {
    "VALIDATION_ERROR": "Dados de entrada inválidos (Zod validation)",
    "UNAUTHORIZED": "Autenticação necessária (sem sessão válida)",
    "FORBIDDEN": "Sem permissão para realizar esta ação",
    "WORKSPACE_NOT_FOUND": "Workspace não encontrado",
    "SPACE_NOT_FOUND": "Space não encontrado",
    "FILE_NOT_FOUND": "Arquivo não encontrado",
    "NO_FILE": "Nenhum arquivo foi enviado no upload",
    "INVALID_FILE_TYPE": "Tipo de arquivo não permitido (apenas imagens)",
    "FILE_SIZE_LIMIT_EXCEEDED": "Arquivo excede o tamanho máximo de 25MB",
    "LIMIT_REACHED": "Limite de evidências do plano atingido",
    "NO_ACTIVE_SUBSCRIPTION": "Workspace sem assinatura ativa",
    "UPLOAD_FAILED": "Erro ao fazer upload para o Cloudinary",
    "SPACE_NOT_IN_WORKSPACE": "Space não pertence ao workspace especificado",
    "NOT_WORKSPACE_MEMBER": "Usuário não é membro do workspace",
    "INTERNAL_ERROR": "Erro interno do servidor"
  },

  "models": {
    "Space": {
      "id": "number",
      "workspaceId": "number",
      "name": "string",
      "description": "string | null",
      "createdBy": "number",
      "createdAt": "string (ISO 8601)",
      "updatedAt": "string (ISO 8601)",
      "files": "SpaceFile[]",
      "_count": {
        "files": "number"
      }
    },
    "SpaceFile": {
      "id": "number",
      "spaceId": "number",
      "workspaceId": "number",
      "uploadedBy": "number",
      "provider": "string (cloudinary)",
      "publicId": "string",
      "secureUrl": "string",
      "originalName": "string",
      "originalFormat": "string",
      "storedFormat": "string (webp)",
      "bytes": "number",
      "width": "number | null",
      "height": "number | null",
      "createdAt": "string (ISO 8601)"
    }
  },

  "permissionMatrix": {
    "Space": {
      "CREATE": ["OWNER", "ADMIN", "MEMBER"],
      "READ": ["OWNER", "ADMIN", "MEMBER"],
      "UPDATE": ["OWNER", "ADMIN"],
      "DELETE": ["OWNER"]
    },
    "File": {
      "UPLOAD": ["OWNER", "ADMIN", "MEMBER"],
      "READ": ["OWNER", "ADMIN", "MEMBER"],
      "DELETE": ["OWNER", "ADMIN"]
    }
  },

  "planLimits": {
    "forge_start": {
      "max_evidences": 200,
      "retention_days": 7
    },
    "forge_team": {
      "max_evidences": 500,
      "retention_days": 30
    },
    "forge_enterprise": {
      "max_evidences": 2000,
      "retention_days": -1
    }
  }
}
